window.utils={loadTemplate:function(a,c){var b=[];jQuery.each(a,function(e,d){if(window[d]){b.push(window[d].prototype.template=_.template(jQuery("#"+d).html()))}else{alert(d+" not found")}});jQuery.when.apply(null,b).done(c)},changePage:function(){if(location.hash!==""){jQuery("#main-navbar ul.nav").find("li.active").each(function(){jQuery(this).removeClass("active")});jQuery(".content-tabs").find(".content-tab.active").each(function(){jQuery(this).removeClass("active")});var b=location.hash.split("/");var a=b[0];jQuery(".content-tabs").find(".content-tab"+a).addClass("active");jQuery("#main-navbar ul.nav").find('li a[href="'+a+'"]').parent("li").addClass("active")}},uploadFile:function(b,c){var a=this;var d=new FormData();d.append("file",b);jQuery.ajax({url:"api/upload.php",type:"POST",data:d,processData:false,cache:false,contentType:false}).done(function(){console.log(b.name+" uploaded successfully");c()}).fail(function(){a.showAlert("Error!","An error occurred while uploading "+b.name,"alert-error")})},displayValidationErrors:function(b){for(var a in b){if(b.hasOwnProperty(a)){this.addValidationError(a,b[a])}}this.showAlert("Warning!","Fix validation errors and try again","alert-warning")},addValidationError:function(b,a){var c=jQuery("#"+b).parent().parent();c.addClass("error");jQuery(".help-inline",c).html(a)},removeValidationError:function(a){var b=jQuery("#"+a).parent().parent();b.removeClass("error");jQuery(".help-inline",b).html("")},showAlert:function(c,b,a){jQuery(".alert").removeClass("alert-error alert-warning alert-success alert-info");jQuery(".alert").addClass(a);jQuery(".alert").html("<strong>"+c+"</strong> "+b);jQuery(".alert").show()},hideAlert:function(){jQuery(".alert").hide()}};
window.Match=Backbone.Model.extend({defaults:{pool:"",deltaStartTime:null,localId:null,location:"",locationId:null,locationOnHold:false,matchId:null,round:"",team1Id:null,team1Players:null,team2Id:null,team2Players:null}});window.CurrentMatchCollection=Backbone.Collection.extend({model:Match,url:urlApi,parse:function(b,a){return b.data["Matches.listPlaying"]}});window.UpcomingMatchCollection=Backbone.Collection.extend({model:Match,url:urlApi,parse:function(b,a){return _.map(b.data["Matches.listStatus"],function(c){return c})}});window.FinishedMatchCollection=Backbone.Collection.extend({model:Match,url:urlApi,parse:function(b,a){return _.map(b.data["Matches.listStatus"],function(c){return c})}});window.SearchMatchCollection=Backbone.Collection.extend({model:Match,url:urlApi,parse:function(b,a){return _.map(b.data["Matches.listSearch"],function(c){return c})}});
window.Ranking=Backbone.Model.extend({defaults:{givenUp:false,matchesDraw:null,matchesLost:null,matchesPlayed:null,matchesRelative:"",matchesWon:null,players:null,pointsLost:null,pointsRelative:"",pointsWon:null,rank:null,setsLost:null,setsRelative:"",setsWon:null,teamId:null,}});window.RankingListCollection=Backbone.Collection.extend({model:Ranking,url:urlApi,parse:function(b,a){return b.data["Rankings.pool"]}});
window.Pool=Backbone.Model.extend({defaults:{id:null,name:"",}});window.PoolListCollection=Backbone.Collection.extend({model:Pool,url:urlApi,parse:function(b,a){return _.map(b.data["Pools.list"],function(c){return c})}});
window.CurrentMatchView=Backbone.View.extend({tagName:"tr",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this)},render:function(){jQuery(this.el).html(this.template(this.model.toJSON()));return this}});window.CurrentMatchListView=Backbone.View.extend({tagName:"table",id:"current-matches-table",className:"table team-table",initialize:function(){this.isLoading=false;this.currentMatchCollection=new CurrentMatchCollection();this.currentMatchCollection.bind("add",this.add,this)},render:function(){this.loadResults()},loadResults:function(){var a=this;this.isLoading=true;this.currentMatchCollection.fetch({data:{commands:{0:{command:"Matches.listPlaying"}}},type:"POST",success:(function(b){_(b.models).each(a.add,this);jQuery("#current-matches").append(a.el);jQuery(".tab-content").find(".loadingpane").remove();a.isLoading=false}),error:(function(b){console.log(" Service request failure: "+b)}),})},add:function(a){var b=new CurrentMatchView({model:a});jQuery(this.el).append(b.render().el)},});
window.UpcomingMatchView=Backbone.View.extend({tagName:"tr",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this)},render:function(){jQuery(this.el).html(this.template(this.model.toJSON()));return this}});window.UpcomingMatchListView=Backbone.View.extend({tagName:"table",id:"upcoming-matches-table",className:"table team-table",initialize:function(){this.isLoading=false;this.page=1;this.upcomingMatchCollection=new UpcomingMatchCollection();this.upcomingMatchCollection.bind("add",this.add,this)},events:{"click .loadmore":"loadmore"},render:function(){this.loadResults()},loadResults:function(){var b=this;this.isLoading=true;var c=(this.page-1)*10;var a=10;this.upcomingMatchCollection.fetch({data:{commands:{0:{command:"Matches.listStatus",status:"ready",startPos:c,limit:a}}},type:"POST",success:(function(d){jQuery(".tab-content").find(".loadmore").parent().parent().remove();_(d.models).each(b.add,this);if(d.models.length==a){jQuery(b.el).append('<tr><td colspan="4" class="loadmore-row"><button class="loadmore btn btn-default btn-block">Load more matches</button></td></tr>')}jQuery("#upcoming-matches").append(b.el);b.delegateEvents();jQuery(".tab-content").find(".loadingpane").remove();b.isLoading=false}),error:(function(d){console.log(" Service request failure: "+d)}),})},add:function(a){var b=new UpcomingMatchView({model:a});jQuery(this.el).append(b.render().el)},loadmore:function(){if(!this.isLoading){jQuery(".tab-content").find(".loadmore").prop("disabled",true).html("Loading...");this.page+=1;this.loadResults()}},});
window.FinishedMatchView=Backbone.View.extend({tagName:"tr",render:function(){jQuery(this.el).html(this.template(this.model.toJSON()));return this}});window.FinishedMatchListView=Backbone.View.extend({tagName:"table",id:"finished-matches-table",className:"table team-table",initialize:function(){this.isLoading=false;this.page=1;this.finishedMatchCollection=new FinishedMatchCollection();this.finishedMatchCollection.bind("add",this.add,this)},events:{"click .loadmore":"loadmore"},render:function(){this.loadResults()},loadResults:function(){var b=this;this.isLoading=true;var c=(this.page-1)*10;var a=10;this.finishedMatchCollection.fetch({data:{commands:{0:{command:"Matches.listStatus",status:"played",startPos:c,limit:a,sortOrder:"DESC"}}},type:"POST",success:(function(d){jQuery(".tab-content").find(".loadmore").parent().parent().remove();_(d.models).each(b.add,this);if(d.models.length==a){jQuery(b.el).append('<tr><td colspan="4" class="loadmore-row"><button class="loadmore btn btn-default btn-block">Load more matches</button></td></tr>')}jQuery("#finished-matches").append(b.el);b.delegateEvents();jQuery(".tab-content").find(".loadingpane").remove();b.isLoading=false}),error:(function(d){console.log(" Service request failure: "+d)}),})},add:function(a){var b=new FinishedMatchView({model:a});jQuery(this.el).append(b.render().el)},loadmore:function(){if(!this.isLoading){jQuery(".tab-content").find(".loadmore").prop("disabled",true).html("Loading...");this.page+=1;this.loadResults()}},});
window.SearchMatchView=Backbone.View.extend({tagName:"tr",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.close,this)},render:function(){jQuery(this.el).html(this.template(this.model.toJSON()));return this}});window.SearchMatchesListView=Backbone.View.extend({tagName:"table",className:"table team-table",initialize:function(a){this.isLoading=false;if(typeof a.query=="undefined"){console.log("Error: No search query given to load player matches from")}this.searchQuery=a.query;this.searchMatchCollection=new SearchMatchCollection();this.searchMatchCollection.bind("add",this.add,this)},render:function(){this.loadResults()},loadResults:function(){var a=this;this.isLoading=true;this.searchMatchCollection.fetch({data:{commands:{0:{command:"Matches.listSearch",searchQuery:this.searchQuery}}},type:"POST",success:(function(b){_(b.models).each(a.add,this);jQuery(".table-wrapper").append(a.el);jQuery(".table-title").text("Search: "+a.searchQuery);jQuery(".table-wrapper").find(".loadingpane").remove();a.isLoading=false}),error:(function(b){console.log(" Service request failure: "+b)}),})},add:function(b){var a=new SearchMatchView({model:b});jQuery(this.el).append(a.render().el)},});
window.RankingView=Backbone.View.extend({tagName:"tr",render:function(){jQuery(this.el).html(this.template(this.model.toJSON()));return this}});window.RankingListView=Backbone.View.extend({tagName:"table",id:"ranking-table",className:"table team-table",initialize:function(a){this.isLoading=false;if(typeof a.poolId=="undefined"){console.log("Error: No pool given to load rankings from")}this.poolId=a.poolId;this.rankingListCollection=new RankingListCollection();this.rankingListCollection.bind("add",this.add,this)},render:function(){this.loadResults()},loadResults:function(){var a=this;this.isLoading=true;this.rankingListCollection.fetch({data:{commands:{0:{command:"Rankings.pool",poolId:this.poolId}}},type:"POST",success:(function(b){_(b.models).each(a.add,this);jQuery(".table-wrapper").append(a.el);a.delegateEvents();jQuery(".table-wrapper").find(".loadingpane").remove();a.isLoading=false}),error:(function(b){console.log(" Service request failure: "+b)}),})},add:function(b){b.set("poolId",this.poolId);var a=new RankingView({model:b});jQuery(this.el).append(a.render().el)},});
window.PoolSelectorView=Backbone.View.extend({render:function(){jQuery(this.el).html(this.template(this.model.toJSON()));return this}});window.PoolSelectorListView=Backbone.View.extend({className:"list",initialize:function(a){this.poolId=a.poolId;this.isLoading=false;this.poolListCollection=new PoolListCollection();this.bind("change",this.loadResults());this.poolListCollection.bind("add",this.add,this)},render:function(){this.loadResults()},loadResults:function(){var a=this;this.isLoading=true;this.poolListCollection.fetch({data:{commands:{0:{command:"Pools.list"}}},type:"POST",success:(function(b){jQuery("#pool-select .list").remove();_(b.models).each(a.add,this);jQuery("#pool-select").append(a.el);a.delegateEvents();a.isLoading=false}),error:(function(b){console.log(" Service request failure: "+b)}),})},add:function(a){if(this.poolId==a.id){jQuery("#pool-select .current .pool").html('<small class="muted">Pool</small>'+a.get("name"))}var b=new PoolSelectorView({model:a});jQuery(this.el).append(b.render().el)},});
var AppRouter=Backbone.Router.extend({routes:{"":"currentMatchList",matches:"currentMatchList","matches/current-matches":"currentMatchList","matches/upcoming-matches":"upcomingMatchList","matches/finished-matches":"finishedMatchList",rankings:"rankingList","rankings/:poolId":"rankingList","player/:playerId":"playerOverview","player/:playerId/overview":"playerOverview","player/:playerId/ranking/:poolId":"playerRanking","player/:playerId/matches/":"playerMatches","search/:query":"searchPlayer"},initialize:function(){this.bind("all",this.change)},change:function(){utils.changePage();jQuery(".tab-content").find("table").each(function(){this.remove()});jQuery(".content-tabs").find("table").each(function(){this.remove()});if(jQuery(".tab-content").find(".loadingpane").length==0){jQuery(".tab-content").append('<div class="loadingpane"><div class="logo spinner"><i class="glyphicon glyphicon-bookmark"></i> Tournia.net</div></div></div>')}if(jQuery(".table-wrapper").find(".loadingpane").length==0){jQuery(".table-wrapper").append('<div class="loadingpane"><div class="logo spinner"><i class="glyphicon glyphicon-bookmark"></i> Tournia.net</div></div></div>')}},currentMatchList:function(){var a=new CurrentMatchListView();a.render()},upcomingMatchList:function(b){var a=new UpcomingMatchListView();a.render()},finishedMatchList:function(b){var a=new FinishedMatchListView();a.render()},rankingList:function(a){jQuery(".loadingpane").find(".logo").removeClass("spinner");var c=new PoolSelectorListView({poolId:a});c.render();if(typeof a!="undefined"){jQuery(".loadingpane").find(".logo").addClass("spinner");jQuery("#pool-select .current .pool").html('<small class="muted">Pool</small> Loading pool...');var b=new RankingListView({poolId:a});b.render()}else{jQuery("#pool-select .current .pool").html('<small class="muted">Pool</small> Select pool')}},playerOverview:function(a){console.log("playerOverview (playerId: "+a+")")},playerRanking:function(b,a){console.log("playerRanking (playerId: "+b+", poolId: "+a+")")},playerMatches:function(a){console.log("playerMatches (playerId: "+a+")")},searchPlayer:function(b){var b=b.split("+").join(" ");var a=new SearchMatchesListView({query:b});a.render()}});utils.loadTemplate(["CurrentMatchView","UpcomingMatchView","FinishedMatchView","SearchMatchView","RankingView","PoolSelectorView"],function(){app=new AppRouter();Backbone.history.start()});